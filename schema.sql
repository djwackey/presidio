-- Database schema for medical data de-identification system
-- Created with Claude Code

-- Table for storing recognizer type definitions
CREATE TABLE `recognizer_types` (
  `id` int NOT NULL AUTO_INCREMENT,
  `name` varchar(50) NOT NULL,
  `module_path` varchar(255) NOT NULL,
  `class_name` varchar(100) NOT NULL,
  `description` text,
  `entity_type` varchar(50) NOT NULL,
  `replacement` varchar(100) NOT NULL,
  `created_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci;

-- Table for storing anonymizer profiles
CREATE TABLE `anonymizer_profiles` (
  `id` int NOT NULL AUTO_INCREMENT,
  `name` varchar(50) NOT NULL,
  `description` text,
  `is_default` tinyint(1) DEFAULT '0',
  `created_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `unique_profile_name` (`name`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci;

INSERT INTO `anonymizer_profiles` VALUES (1,'medical_records','Default profile for medical record anonymization',1,CURRENT_TIMESTAMP,CURRENT_TIMESTAMP);

-- Junction table for profile-recognizer relationships
CREATE TABLE `profile_recognizer_settings` (
  `profile_id` int NOT NULL,
  `recognizer_id` int NOT NULL,
  `enabled` tinyint(1) DEFAULT '1',
  `parameters` json DEFAULT NULL,
  `priority` int NOT NULL DEFAULT '1',
  `created_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`profile_id`,`recognizer_id`),
  KEY `recognizer_id` (`recognizer_id`),
  KEY `idx_priority` (`priority`),
  CONSTRAINT `profile_recognizer_settings_ibfk_1` FOREIGN KEY (`profile_id`) REFERENCES `anonymizer_profiles` (`id`) ON DELETE CASCADE,
  CONSTRAINT `profile_recognizer_settings_ibfk_2` FOREIGN KEY (`recognizer_id`) REFERENCES `recognizer_types` (`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci;

-- Insert default recognizer types
INSERT INTO `recognizer_types` VALUES (1,'ID Card','chinese_anonymizer.dynamic_recognizer','DynamicRecognizer','Chinese ID card number recognition','ID_CARD','<ID_CARD>','2025-10-29 02:51:13','2025-10-30 08:02:15'),(2,'Phone','chinese_anonymizer.dynamic_recognizer','DynamicRecognizer','Chinese phone number recognition','PHONE_NUMBER','<PHONE>','2025-10-29 02:51:13','2025-10-30 08:02:15'),(3,'Person','chinese_anonymizer.dynamic_recognizer','DynamicRecognizer','Chinese person name recognition','PERSON','<NAME>','2025-10-29 02:51:13','2025-10-30 07:56:23'),(4,'Address','chinese_anonymizer.dynamic_recognizer','DynamicRecognizer','Chinese address recognition','ADDRESS','<ADDRESS>','2025-10-29 02:51:13','2025-10-30 08:02:16'),(5,'Inpatient','chinese_anonymizer.dynamic_recognizer','DynamicRecognizer','Inpatient medical record recognition','INPATIENT_NO','<INPATIENT>','2025-10-29 02:51:13','2025-10-30 08:02:16'),(6,'Outpatient','chinese_anonymizer.dynamic_recognizer','DynamicRecognizer','Outpatient medical record recognition','OUTPATIENT_NO','<OUTPATIENT>','2025-10-29 02:51:13','2025-10-30 08:02:16'),(7,'Bank Card','chinese_anonymizer.dynamic_recognizer','DynamicRecognizer','Bank card NO recognition','BANK_CARD','<BANK_CARD>','2025-10-31 07:19:49','2025-10-31 07:19:49'),(8,'Settlement NO','chinese_anonymizer.dynamic_recognizer','DynamicRecognizer','Settlement NO recognition','SETTLEMENT_NO','<SETTLEMENT_NO>','2025-10-31 07:19:49','2025-10-31 07:19:49'),(9,'Payment Amount','chinese_anonymizer.dynamic_recognizer','DynamicRecognizer','Payment amount recognition','PAYMENT_AMOUNT','<PAYMENT_AMOUNT>','2025-10-31 07:19:49','2025-10-31 07:19:49'),(10,'Payment Password','chinese_anonymizer.dynamic_recognizer','DynamicRecognizer','Payment password recognition','PAYMENT_PASSWORD','<PAYMENT_PASSWORD>','2025-10-31 07:19:49','2025-10-31 07:19:49'),(11,'Date Time','chinese_anonymizer.dynamic_recognizer','DynamicRecognizer','Datetime recognition','DATE_TIME','<DATE_TIME>','2025-10-31 07:19:49','2025-10-31 07:19:49'),(12,'Medical Test','chinese_anonymizer.dynamic_recognizer','DynamicRecognizer','Medical test result recognition','MEDICAL_TEST','<MEDICAL_TEST>','2025-10-29 02:51:13','2025-10-31 07:19:50');

INSERT INTO `profile_recognizer_settings` VALUES (1,1,1,'{\"context\": [], \"patterns\": [{\"name\": \"id_card\", \"regex\": \"\\\\b[1-9]\\\\d{5}(19|20)\\\\d{2}(0[1-9]|1[0-2])(0[1-9]|[12]\\\\d|3[01])\\\\d{3}[\\\\dXx]\\\\b\", \"score\": 0.95}], \"supported_entity\": \"ID_CARD\"}',1,'2025-10-30 08:06:07','2025-10-30 08:30:03'),(1,2,1,'{\"context\": [\"电话\", \"手机\", \"联系方式\", \"手机号\", \"电话号码\", \"联系电话\", \"phone\", \"mobile\", \"tel\", \"contact\"], \"patterns\": [{\"name\": \"CHINESE_PHONE_PATTERN\", \"regex\": \"(?<!\\\\d)1[3-9]\\\\d{9}(?!\\\\d)\", \"score\": 0.9}, {\"name\": \"CHINESE_PHONE_WITH_SPACES\", \"regex\": \"\\\\b1[3-9]\\\\d\\\\s?\\\\d{4}\\\\s?\\\\d{4}\\\\b\", \"score\": 0.8}, {\"name\": \"CHINESE_PHONE_WITH_DASHES\", \"regex\": \"\\\\b1[3-9]\\\\d-\\\\d{4}-\\\\d{4}\\\\b\", \"score\": 0.8}], \"supported_entity\": \"PHONE_NUMBER\"}',2,'2025-10-30 08:06:07','2025-10-30 08:30:47'),(1,3,1,'{\"context\": [\"姓名\", \"名字\", \"称呼\", \"患者\", \"病人\", \"先生\", \"女士\", \"同志\", \"name\", \"patient\", \"person\", \"mr\", \"ms\", \"男\", \"女\"], \"patterns\": [{\"name\": \"CHINESE_NAME_WITH_CONTEXT\", \"regex\": \"(?<=患者|病人|姓名|名字)[\\\\s：:]*(丁|万|上官|东方|乌|乔|于|云|井|仓|令狐|任|伊|伍|何|余|侯|俞|倪|傅|党|公乘|公仪|公仲|公冶|公叔|公孟|公明|公玉|公羊|公良|公西|关|冉|农|冯|刘|劳|包|华|单|南|南宫|卢|史|叶|司徒|司空|司马|吕|吴|周|哈|唐|夏|夏侯|姚|姜|子|子车|孔|孙|孟|宁|宇文|宋|宝|容|尉迟|尚|尤|尹|屈|岳|崔|巴|席|常|平|年|应|庞|康|廖|张|彭|徐|惠|慕容|成|戴|房|才|文|方|易|景|曲|曹|曾|木|朱|李|杜|杨|林|查|柯|柳|梁|梅|欧|欧阳|武|段|毛|江|汤|汪|沈|沙|洪|涂|滕|潘|熊|牛|独孤|王|瓦|甘|田|申|白|皇甫|皮|盛|石|祁|秦|程|穆|章|童|端木|符|米|纪|纳|罗|聂|肖|胡|臧|舒|苏|苗|范|茅|莫|萧|萨|葛|董|蒋|蓝|蔡|薛|虞|袁|裴|西门|言|计|许|诸葛|谢|谭|谷|费|贺|贾|赖|赵|车|辛|达|邓|邬|邱|邵|邹|郁|郎|郑|郝|郭|鄂|金|钟|钱|长孙|闵|阎|阮|阿|陆|陈|陶|雷|韦|韩|项|顾|马|骆|高|魏|鲁|麦|黄|黎|齐|龙|龚)[\\\\u4e00-\\\\u9fff]{1,2}\", \"score\": 0.95}, {\"name\": \"CHINESE_NAME_PATTERN\", \"regex\": \"(?<=^|[，。！？\\\\s])(丁|万|上官|东方|乌|乔|于|云|井|仓|令狐|任|伊|伍|何|余|侯|俞|倪|傅|党|公乘|公仪|公仲|公冶|公叔|公孟|公明|公玉|公羊|公良|公西|关|冉|农|冯|刘|劳|包|华|单|南|南宫|卢|史|叶|司徒|司空|司马|吕|吴|周|哈|唐|夏|夏侯|姚|姜|子|子车|孔|孙|孟|宁|宇文|宋|宝|容|尉迟|尚|尤|尹|屈|岳|崔|巴|席|常|平|年|应|庞|康|廖|张|彭|徐|惠|慕容|成|戴|房|才|文|方|易|景|曲|曹|曾|木|朱|李|杜|杨|林|查|柯|柳|梁|梅|欧|欧阳|武|段|毛|江|汤|汪|沈|沙|洪|涂|滕|潘|熊|牛|独孤|王|瓦|甘|田|申|白|皇甫|皮|盛|石|祁|秦|程|穆|章|童|端木|符|米|纪|纳|罗|聂|肖|胡|臧|舒|苏|苗|范|茅|莫|萧|萨|葛|董|蒋|蓝|蔡|薛|虞|袁|裴|西门|言|计|许|诸葛|谢|谭|谷|费|贺|贾|赖|赵|车|辛|达|邓|邬|邱|邵|邹|郁|郎|郑|郝|郭|鄂|金|钟|钱|长孙|闵|阎|阮|阿|陆|陈|陶|雷|韦|韩|项|顾|马|骆|高|魏|鲁|麦|黄|黎|齐|龙|龚)[\\\\u4e00-\\\\u9fff]{1,2}(?=[，。！？\\\\s]|$)\", \"score\": 0.9}, {\"name\": \"CHINESE_NAME_WITH_TITLE\", \"regex\": \"(丁|万|上官|东方|乌|乔|于|云|井|仓|令狐|任|伊|伍|何|余|侯|俞|倪|傅|党|公乘|公仪|公仲|公冶|公叔|公孟|公明|公玉|公羊|公良|公西|关|冉|农|冯|刘|劳|包|华|单|南|南宫|卢|史|叶|司徒|司空|司马|吕|吴|周|哈|唐|夏|夏侯|姚|姜|子|子车|孔|孙|孟|宁|宇文|宋|宝|容|尉迟|尚|尤|尹|屈|岳|崔|巴|席|常|平|年|应|庞|康|廖|张|彭|徐|惠|慕容|成|戴|房|才|文|方|易|景|曲|曹|曾|木|朱|李|杜|杨|林|查|柯|柳|梁|梅|欧|欧阳|武|段|毛|江|汤|汪|沈|沙|洪|涂|滕|潘|熊|牛|独孤|王|瓦|甘|田|申|白|皇甫|皮|盛|石|祁|秦|程|穆|章|童|端木|符|米|纪|纳|罗|聂|肖|胡|臧|舒|苏|苗|范|茅|莫|萧|萨|葛|董|蒋|蓝|蔡|薛|虞|袁|裴|西门|言|计|许|诸葛|谢|谭|谷|费|贺|贾|赖|赵|车|辛|达|邓|邬|邱|邵|邹|郁|郎|郑|郝|郭|鄂|金|钟|钱|长孙|闵|阎|阮|阿|陆|陈|陶|雷|韦|韩|项|顾|马|骆|高|魏|鲁|麦|黄|黎|齐|龙|龚)[\\\\u4e00-\\\\u9fff]{1,2}(?=女士|先生|同志|医生|教授|老师)\", \"score\": 0.95}, {\"name\": \"CHINESE_TWO_CHAR_NAME\", \"regex\": \"(?<=^|[，。！？\\\\s])(丁|万|上官|东方|乌|乔|于|云|井|仓|令狐|任|伊|伍|何|余|侯|俞|倪|傅|党|公乘|公仪|公仲|公冶|公叔|公孟|公明|公玉|公羊|公良|公西|关|冉|农|冯|刘|劳|包|华|单|南|南宫|卢|史|叶|司徒|司空|司马|吕|吴|周|哈|唐|夏|夏侯|姚|姜|子|子车|孔|孙|孟|宁|宇文|宋|宝|容|尉迟|尚|尤|尹|屈|岳|崔|巴|席|常|平|年|应|庞|康|廖|张|彭|徐|惠|慕容|成|戴|房|才|文|方|易|景|曲|曹|曾|木|朱|李|杜|杨|林|查|柯|柳|梁|梅|欧|欧阳|武|段|毛|江|汤|汪|沈|沙|洪|涂|滕|潘|熊|牛|独孤|王|瓦|甘|田|申|白|皇甫|皮|盛|石|祁|秦|程|穆|章|童|端木|符|米|纪|纳|罗|聂|肖|胡|臧|舒|苏|苗|范|茅|莫|萧|萨|葛|董|蒋|蓝|蔡|薛|虞|袁|裴|西门|言|计|许|诸葛|谢|谭|谷|费|贺|贾|赖|赵|车|辛|达|邓|邬|邱|邵|邹|郁|郎|郑|郝|郭|鄂|金|钟|钱|长孙|闵|阎|阮|阿|陆|陈|陶|雷|韦|韩|项|顾|马|骆|高|魏|鲁|麦|黄|黎|齐|龙|龚)[\\\\u4e00-\\\\u9fff](?=[，。！？\\\\s]|$)\", \"score\": 0.8}], \"score_threshold\": 0.5, \"supported_entity\": \"PERSON\"}',3,'2025-10-30 07:59:28','2025-10-30 08:06:07'),(1,4,1,'{\"context\": [], \"patterns\": [{\"name\": \"chinese_address\", \"regex\": \"([\\\\u4e00-\\\\u9fff]{1,5}(?:省|自治区|市|县|区|镇|乡|村|街道|路|巷|弄))([\\\\u4e00-\\\\u9fff0-9a-zA-Z\\\\-]+)\", \"score\": 0.85}], \"supported_entity\": \"ADDRESS\"}',4,'2025-10-30 08:31:58','2025-10-30 08:34:23'),(1,5,1,'{\"context\": [], \"patterns\": [{\"name\": \"inpatient\", \"regex\": \"\\\\bZY\\\\d{6,10}\\\\b\", \"score\": 0.8}, {\"name\": \"inpatient_chinese\", \"regex\": \"\\\\b住院\\\\d{6,10}\\\\b\", \"score\": 0.8}], \"supported_entity\": \"INPATIENT_NO\"}',5,'2025-10-30 08:31:59','2025-10-30 08:34:52'),(1,6,1,'{\"context\": [], \"patterns\": [{\"name\": \"outpatient\", \"regex\": \"\\\\bMZ\\\\d{6,10}\\\\b\", \"score\": 0.8}, {\"name\": \"outpatient_chinese\", \"regex\": \"\\\\b门诊\\\\d{6,10}\\\\b\", \"score\": 0.8}], \"supported_entity\": \"OUTPATIENT_NO\"}',6,'2025-10-30 08:31:59','2025-10-30 08:35:18'),(1,7,1,'{\"context\": [], \"patterns\": [{\"name\": \"bank_card\", \"regex\": \"\\\\b(62\\\\d{14,17}|94\\\\d{14,17}|35\\\\d{14,17}|5[1-5]\\\\d{14}|4\\\\d{15})\\\\b\", \"score\": 0.85}, {\"name\": \"bank_card_with_spaces\", \"regex\": \"\\\\b(\\\\d{4}[-\\\\s]?\\\\d{4}[-\\\\s]?\\\\d{4}[-\\\\s]?\\\\d{4,7})\\\\b\", \"score\": 0.75}], \"supported_entity\": \"BANK_CARD\"}',7,'2025-10-31 07:21:24','2025-10-31 07:54:36'),(1,8,1,'{\"context\": [], \"patterns\": [{\"name\": \"settlement_receipt\", \"regex\": \"\\\\b[a-f0-9]{8}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{12}\\\\b\", \"score\": 0.85}, {\"name\": \"settlement_receipt_chinese\", \"regex\": \"\\\\b结算单号[:：]\\\\s*[a-f0-9]{8}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{12}\\\\b\", \"score\": 0.9}], \"supported_entity\": \"SETTLEMENT_NO\"}',8,'2025-10-31 07:21:24','2025-10-31 07:54:36'),(1,9,1,'{\"context\": [], \"patterns\": [{\"name\": \"payment_amount_yuan\", \"regex\": \"\\\\b\\\\d{1,3}(?:,\\\\d{3})*(?:\\\\.\\\\d+)?\\\\s*[\\\\u5143]\\\\b\", \"score\": 0.95}, {\"name\": \"payment_amount_rmb\", \"regex\": \"\\\\b\\\\d{1,3}(?:,\\\\d{3})*(?:\\\\.\\\\d+)?\\\\s*\\\\u4EBA\\\\u6C11\\\\u5E01\\\\b\", \"score\": 0.95}, {\"name\": \"payment_amount_symbol\", \"regex\": \"\\\\b[\\\\xA5\\\\uffe5]\\\\d{1,3}(?:,\\\\d{3})*(?:\\\\.\\\\d+)?\\\\b\", \"score\": 0.95}], \"supported_entity\": \"PAYMENT_AMOUNT\"}',9,'2025-10-31 07:21:25','2025-10-31 07:54:37'),(1,10,1,'{\"context\": [], \"patterns\": [{\"name\": \"payment_password\", \"regex\": \"\\\\b\\\\d{6}\\\\b\", \"score\": 0.85}], \"supported_entity\": \"PAYMENT_PASSWORD\"}',10,'2025-10-31 07:21:25','2025-10-31 07:54:37'),(1,11,1,'{\"context\": [], \"patterns\": [{\"name\": \"chinese_date\", \"regex\": \"\\\\b\\\\d{4}年\\\\d{1,2}月\\\\d{1,2}日\\\\b|\\\\b\\\\d{4}[-/]\\\\d{1,2}[-/]\\\\d{1,2}\\\\b\", \"score\": 0.85}, {\"name\": \"chinese_time\", \"regex\": \"\\\\b\\\\d{1,2}[:：]\\\\d{1,2}(?::\\\\d{1,2})?\\\\b|\\\\b\\\\d{1,2}点\\\\d{1,2}分(?:\\\\d{1,2}秒)?\\\\b\", \"score\": 0.8}, {\"name\": \"chinese_datetime\", \"regex\": \"\\\\b\\\\d{4}年\\\\d{1,2}月\\\\d{1,2}日\\\\s+\\\\d{1,2}[:：]\\\\d{1,2}\\\\b|\\\\b\\\\d{4}[-/]\\\\d{1,2}[-/]\\\\d{1,2}\\\\s+\\\\d{1,2}[:：]\\\\d{1,2}\\\\b\", \"score\": 0.9}], \"supported_entity\": \"DATE_TIME\"}',11,'2025-10-31 07:21:25','2025-10-31 07:54:37');
